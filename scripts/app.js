!function(){"use strict";angular.module("app",["ngRoute","ngAnimate","ngAria","ui.bootstrap","ngTagsInput","textAngular","angular-loading-bar","ui.calendar","duScroll","mgo-angular-wizard","angular-jwt","ngecharts","app.nav","app.i18n","app.ui","app.page","app.filter","app.engine","app.account","app.api","app.server","app.log","app.dashboard","angularBootstrapNavTree"])}(),function(){"use strict";angular.module("app.nav",[])}(),function(){"use strict";angular.module("app.page",[])}(),function(){"use strict";angular.module("app.ui",[])}(),function(){"use strict";angular.module("app").factory("appConfig",[function(){var e=[{name:"Fade up",class:"animate-fade-up"},{name:"Scale up",class:"ainmate-scale-up"},{name:"Slide in from right",class:"ainmate-slide-in-right"},{name:"Flip Y",class:"animate-flip-y"}],n=(new Date).getFullYear();return{pageTransitionOpts:e,main:{brand:"ezBastion ",name:JSON.parse(localStorage.getItem("user")),year:n,layout:"wide",isMenuCollapsed:!1,fixedHeader:!0,fixedSidebar:!0,pageTransition:e[0],skin:"31",refreshBell:!1,promiseBell:void 0},color:{primary:"#1C7EBB",success:"#23AE89",info:"#2EC1CC",infoAlt:"#6A55C2",warning:"#FFB61C",danger:"#E94B3B",gray:"#DCDCDC"}}}]).factory("ezbConfig",["$http","$q",function(e,n){return{get:function(){var t=n.defer(),a=localStorage.getItem("ezb_url");return null==a?e.get("config.json").then(function(e){localStorage.setItem("ezb_url",angular.toJson(e.data)),t.resolve(e.data)},function(e){console.log(e.statusText+": "+e.data),t.reject(e.statusText+": "+e.data)}):t.resolve(JSON.parse(a)),t.promise},set:function(e,t){var a=n.defer();return localStorage.setItem(e,angular.toJson(t)),a.resolve(!0),a.promise}}}])}(),function(){"use strict";angular.module("app").controller("AppCtrl",["$scope","$rootScope","$route","$document","appConfig","Auth","$location","ezApiStorage","$interval",function(e,n,t,a,o,r,i,c,l){function s(){c.refresh("logs/todayerror").then(function(n){e.nbAlert=n},function(e){console.log(e)})}e.pageTransitionOpts=o.pageTransitionOpts,e.main=o.main,e.color=o.color,localStorage.getItem("user")?e.user=r.getCurrentUser():e.user={},e.nbAlert=[],e.startRefeshBell=function(){angular.isDefined(e.main.promiseBell)||(e.main.promiseBell=l(function(){s()},6e4))},e.stopRefreshBell=function(){angular.isDefined(e.main.promiseBell)&&(l.cancel(e.main.promiseBell),e.main.promiseBell=void 0)},e.$watch("main",function(n,t){!1===n.fixedHeader&&!0===n.fixedSidebar&&(!1===t.fixedHeader&&!1===t.fixedSidebar&&(e.main.fixedHeader=!0,e.main.fixedSidebar=!0),!0===t.fixedHeader&&!0===t.fixedSidebar&&(e.main.fixedHeader=!1,e.main.fixedSidebar=!1)),!0===n.fixedSidebar&&(e.main.fixedHeader=!0),!1===n.fixedHeader&&(e.main.fixedSidebar=!1),!0===n.refreshBell?e.startRefeshBell():e.stopRefreshBell()},!0),n.$on("$stateChangeSuccess",function(n,t,o){r.isLoggedIn()?a.scrollTo(0,0):(e.main.refreshBell=!1,i.path("/page/signin"))}),e.loging=function(n){r.setUser(e.user).then(function(n){e.usr=r.getCurrentUser(),console.dir(),e.user.pwd=null,i.path("/"),e.main.name=e.usr,s()},function(n){e.user.pwd=null})},e.logoff=function(){r.logoff()}}])}(),function(){"use strict";angular.module("app").config(["$routeProvider",function(e){var n;n=function(n){var t,a;return a="/"+n,t={templateUrl:"app/"+n+".html"},e.when(a,t),e},["dashboard","filter/access","engine/license","engine/tag","account/ad","account/internal","api/action","api/group","api/script","server/server","log","page/signin"].forEach(function(e){return n(e)}),e.when("/",{redirectTo:"/dashboard"}).when("/dashboard",{templateUrl:"app/dashboard/dashboard.html"}).when("/log",{templateUrl:"app/log/log.html"}).when("/404",{templateUrl:"app/page/404.html"}).otherwise({redirectTo:"/404"})}])}(),function(){angular.module("app.i18n",["pascalprecht.translate"]).config(["$translateProvider",function(e){e.useStaticFilesLoader({prefix:"assets/i18n/",suffix:".json"}),e.preferredLanguage("en"),e.useSanitizeValueStrategy(null)}]).controller("LangCtrl",["$scope","$translate",function(e,n){e.lang="English",e.setLang=function(t){switch(t){case"English":n.use("en");break;case"Français":n.use("fr");break;case"Español":n.use("es");break;case"中文":n.use("zh");break;case"日本語":n.use("ja");break;case"Portugal":n.use("pt");break;case"Русский язык":n.use("ru")}return e.lang=t},e.getFlag=function(){switch(e.lang){case"English":return"flags-american";case"Français":return"flags-france";case"Español":return"flags-spain";case"中文":return"flags-china";case"Portugal":return"flags-portugal";case"日本語":return"flags-japan";case"Русский язык":return"flags-russia"}}}])}(),function(){"use strict";angular.module("app.dashboard",[])}(),function(){"use strict";angular.module("app.dashboard").controller("DashboardCtrl",["$scope","ezApiStorage","logger","Auth","$location","$q",function(e,n,t,a,o,r){e.bar1={},e.pieBastion={},e.pieToken={},e.pieController={},e.pieAction={},e.statAccess=[],e.statError=[],e.statData=[];var i=new Date;e.dt=new Date;var c=i.getFullYear(),l=("0"+(i.getMonth()+1)).slice(-2);e.apiNB={},e.accountsNB={},e.bastionsNB={},e.workersNB={};var s=function(a){var o=r.defer();return n.refresh(a).then(function(n){e[a]=n,o.resolve(!0)},function(e){t.logError(a+": "+e),o.reject(!1)}),o.promise},u=function(n,t){e.today=function(){e.dt=new Date},e.format="MMMM yyyy",e.popupDate={opened:!1},e.today(),e.openDateFilter=function(){e.popupDate.opened=!0},e.clear=function(){e.dt=i},e.dateOptions={formatYear:"yyyy",datepickerMode:"month",minMode:"month",minDate:n,maxDate:t},e.disabled=function(e,n){return"month"===n}};e.$watch("dt",function(e,n,t){angular.equals(e,n)||e&&(c=e.getFullYear(),l=("0"+(e.getMonth()+1)).slice(-2),f())},!0);var d=function(e,t,a){n.get("stat/elm/"+e+"/"+c+"/"+l).then(function(e){var n=e.map(e=>e.Elm),o=[];e.forEach(e=>{o.splice(-1,0,{name:e.Elm,value:e.Access})}),a.options={title:{text:t},legend:{data:n},series:[{name:t,data:o}]}},function(e){})},f=function(){d("token","Token",e.pieToken),d("controller","Controller",e.pieController),d("action","Action",e.pieAction),d("bastion","Bastion",e.pieBastion)};a.isLoggedIn()?r.all([function(){var n=r.defer();e.bar1.options={tooltip:{trigger:"axis"},legend:{data:["Access","Error"]},toolbox:{show:!0,feature:{saveAsImage:{show:!0,title:"save"}}},calculable:!0,xAxis:[{type:"category",data:[]}],yAxis:[{type:"value"}],series:[{name:"Access",type:"bar",data:[],itemStyle:{normal:{color:"#449DD5"}},markPoint:{data:[{type:"max",name:"Max"},{type:"min",name:"Min"}]},markLine:{data:[{type:"average",name:"Average"}]}},{name:"Error",type:"bar",data:[],itemStyle:{normal:{color:"#E94B3B"}},markPoint:{data:[{type:"max",name:"Max"},{type:"min",name:"Min"}]},markLine:{data:[{type:"average",name:"Average"}]}}]};var t={title:{text:"Title",x:"center"},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:"vertical",x:"left",data:["Direct","Email","Affiliate","Video Ads","Search"]},toolbox:{show:!0,feature:{saveAsImage:{show:!0,title:"save"}}},calculable:!0,series:[{name:"Traffic source",type:"pie",radius:"55%",center:["50%","60%"],data:[{value:335,name:"Direct",itemStyle:{normal:{color:"#42A4BB"}}},{value:310,name:"Email",itemStyle:{normal:{color:"#5BC0C4"}}},{value:234,name:"Affiliate",itemStyle:{normal:{color:"#78D6C7"}}},{value:135,name:"Video Ads",itemStyle:{normal:{color:"#176799"}}},{value:1548,name:"Search",itemStyle:{normal:{color:"#2F87B0"}}}]}]};return e.pieBastion.options=angular.copy(t),e.pieToken.options=angular.copy(t),e.pieController.options=angular.copy(t),e.pieAction.options=angular.copy(t),n.resolve(!0),n.promise}(),s("actions"),s("api"),s("accounts"),s("workers"),s("bastions")]).then(function(){n.get("stat/access").then(function(t){e.statAccess=t,n.get("stat/error").then(function(n){e.statError=n,e.statAccess.forEach(n=>{var t=new Date(n.Year,n.Month-1),a=e.statError.filter(e=>e.Year==n.Year).find(e=>e.Month==n.Month);e.statData.splice(-1,0,{date:t,dateKey:t.toLocaleString("en-US",{year:"2-digit",month:"short"}),access:n.Count,error:a?a.Count:0})}),e.statData.sort(function(e,n){return e.date>n.date?1:n.date>e.date?-1:0});var t=e.statData.slice(0,1)[0].date,a=e.statData.slice(-1)[0].date;u(t,a),e.bar1.options={xAxis:{data:e.statData.map(e=>e.dateKey)},series:[{name:"Access",data:e.statData.map(e=>e.access)},{name:"Error",data:e.statData.map(e=>e.error)}]}},function(e){})},function(e){}),f(),angular.isArray(e.actions)||(e.actions=[]),angular.isArray(e.api)||(e.api=[]),angular.isArray(e.accounts)||(e.accounts=[]),angular.isArray(e.bastions)||(e.bastions=[]),angular.isArray(e.workers)||(e.workers=[]),e.apiNB.total=e.actions.length,e.apiNB.disable=e.actions.length-e.api.length,e.accountsNB.total=e.accounts.length,e.accountsNB.disable=e.accounts.filter(e=>0==e.enable).length,e.bastionsNB.total=e.bastions.length,e.bastionsNB.disable=e.bastions.filter(e=>0==e.enable).length,e.workersNB.total=e.workers.length,e.workersNB.disable=e.workers.filter(e=>0==e.enable).length}):o.path("/page/signin")}])}(),function(){"use strict";angular.module("app.nav").directive("toggleNavCollapsedMin",["$rootScope",function(e){return{restrict:"A",link:function(n,t,a){var o;o=$("#app"),t.on("click",function(n){return o.hasClass("nav-collapsed-min")?o.removeClass("nav-collapsed-min"):(o.addClass("nav-collapsed-min"),e.$broadcast("nav:reset")),n.preventDefault()})}}}]).directive("accordionNav",function(){return{restrict:"A",link:function(e,n,t){var a,o,r,i,c,l;o=$(n[0]),a=$("#app"),r=$(window),(i=n.find("ul").parent("li")).append('<i class="fa fa-caret-right icon-has-ul"></i>'),i.children("a").on("click",function(e){e.preventDefault()}),o.on("click",function(e){if(!a.hasClass("nav-collapsed-min")){var n=e.target,t=$(n).closest("li"),o=t.children("ul"),r=t.parents().length+1;$("#nav ul").filter(function(){if($(this).parents().length>=r&&this!==o.get(0))return!0}).slideUp(250).closest("li").removeClass("open"),t.has("ul").length&&t.toggleClass("open"),o.slideToggle(250)}}),e.$on("nav:reset",function(e){i.removeClass("open").find("ul").slideUp(250)}),c=r.width(),l=function(){var e;(e=r.width())<768&&a.removeClass("nav-collapsed-min"),c<768&&e>=768&&i.removeClass("open").find("ul").slideUp(250),c=e},r.resize(function(){var e;clearTimeout(e),e=setTimeout(l,300)})}}}).directive("highlightActive",function(){return{restrict:"A",controller:["$scope","$element","$attrs","$location",function(e,n,t,a){var o,r,i;r=n.find("a"),i=function(){return a.path()},(o=function(e,n){return n="#!"+n,angular.forEach(e,function(e){var t,a,o;if(a=angular.element(e),t=a.parent("li"),o=a.attr("href"),t.hasClass("active")&&t.removeClass("active"),0===n.indexOf(o))return t.addClass("active")})})(r,a.path()),e.$watch(i,function(e,n){if(e!==n)return o(r,a.path())})}]}}).directive("toggleOffCanvas",function(){return{restrict:"A",link:function(e,n,t){n.on("click",function(){return $("#app").toggleClass("on-canvas")})}}})}(),function(){"use strict";angular.module("app.page").controller("invoiceCtrl",["$scope","$window",function(e,n){var t,a;e.printInvoice=function(){t=document.getElementById("invoice").innerHTML,document.body.innerHTML,(a=window.open()).document.open(),a.document.write('<html><head><link rel="stylesheet" type="text/css" href="styles/main.css" /></head><body onload="window.print()">'+t+"</html>"),a.document.close()}}]).controller("authCtrl",["$scope","$window","$location",function(e,n,t){e.login=function(){t.url("/")},e.signup=function(){t.url("/")},e.reset=function(){t.url("/")},e.unlock=function(){t.url("/")}}])}(),function(){"use strict";angular.module("app.page").directive("customPage",function(){return{restrict:"A",controller:["$scope","$element","$location",function(e,n,t){var a,o;o=function(){return t.path()},(a=function(e){switch(n.removeClass("body-wide body-err body-lock body-auth body-signin"),e){case"/404":case"/page/404":case"/page/500":return n.addClass("body-wide body-err");case"/page/signin":return n.addClass("body-wide body-signin");case"/page/signup":case"/page/forgot-password":return n.addClass("body-wide body-auth");case"/page/lock-screen":return n.addClass("body-wide body-lock")}})(t.path()),e.$watch(o,function(e,n){if(e!==n)return a(t.path())})}]}})}(),function(){"use strict";angular.module("app.ui").directive("uiTime",function(){return{restrict:"A",link:function(e,n){var t,a;a=function(){var e,o,r,i,c;return c=new Date,e=c.getHours(),o=c.getMinutes(),r=c.getSeconds(),o=t(o),r=t(r),i=e+":"+o+":"+r,n.html(i),setTimeout(a,500)},t=function(e){return e<10&&(e="0"+e),e},a()}}}).directive("uiNotCloseOnClick",function(){return{restrict:"A",compile:function(e,n){return e.on("click",function(e){return e.stopPropagation()})}}}).directive("slimScroll",function(){return{restrict:"A",link:function(e,n,t){return n.slimScroll({height:t.scrollHeight||"100%"})}}}).directive("imgHolder",function(){return{restrict:"A",link:function(e,n,t){return Holder.run({images:n[0]})}}})}(),function(){"use strict";angular.module("app.ui").factory("logger",function(){var e;return toastr.options={closeButton:!0,positionClass:"toast-bottom-right",timeOut:"3000"},e=function(e,n){return toastr[n](e)},{log:function(n){e(n,"info")},logWarning:function(n){e(n,"warning")},logSuccess:function(n){e(n,"success")},logError:function(n){e(n,"error")}}})}(),function(){"use strict";angular.module("app").factory("Auth",["$http","$q","jwtHelper","ezbConfig","logger",function(e,n,t,a,o){var r;return{getCurrentUser:function(){return r},setUser:function(i){var c=n.defer();if(i){var l={grant_type:"password",username:i.name,password:i.pwd};a.get().then(function(n){n.ezb_sta;var a=n.ezb_srv;e.post(a+"authorize",l).then(function(a){var l=t.decodeToken(a.data.access_token),s={headers:{Authorization:"Bearer "+a.data.access_token}};e.get(n.ezb_db+"accounts/"+i.name,s).then(function(e){e.data.enable&&e.data.isadmin?(localStorage.setItem("bearer",a.data.access_token),r={name:i.name,id:e.data.id,comment:e.data.comment,type:e.data.type,real:e.data.real,email:e.data.email},localStorage.setItem("user",angular.toJson(r)),localStorage.setItem("ezb_conf",angular.toJson({expire_in:a.data.expire_in,expire_at:a.data.expire_at,iss:l.iss})),c.resolve("success")):(localStorage.clear(),c.reject("Not granted or disable account."),o.logError("Not granted or disable account."))},function(e){localStorage.clear(),c.reject("Not granted or disable account."),o.logError("Not granted or disable account.")})},function(e){o.logError("Wrong login or password!"),localStorage.clear(),c.reject("Wrong login or password!")})})}else localStorage.clear(),c.resolve("success");return c.promise},logoff:function(){window.location="/",localStorage.clear()},isLoggedIn:function(){var n=localStorage.getItem("bearer");if(null==n)return!1;if(t.isTokenExpired(n))return window.location="/",localStorage.clear(),!1;var a=new Date,o=t.getTokenExpirationDate(n),r=JSON.parse(localStorage.getItem("ezb_conf")),i=JSON.parse(localStorage.getItem("ezb_url"));if(Math.floor((o-a)/1e3)<r.expire_in/4){var c=i.ezb_sta;e({method:"GET",url:c+"renew",headers:{Authorization:"Bearer "+n}}).then(function(e){localStorage.setItem("bearer",e.data.access_token),localStorage.setItem("ezb_conf",angular.toJson({expire_in:e.data.expire_in,expire_at:e.data.expire_at}))},function(e){return localStorage.clear(),window.location="/",!1})}return!0}}}])}(),function(){"use strict";angular.module("app").filter("getNameByID",function(){return function(e,n){return e.find(e=>e.id===n).name}})}(),function(){"use strict";angular.module("app").factory("dbStorage",["$http","$q","Auth","$location","ezbConfig",function(e,n,t,a,o){var r;return{get:function(i){t.isLoggedIn()||a.path("/page/signin");var c={headers:{Authorization:"Bearer "+localStorage.getItem("bearer")}},l=localStorage.getItem(i),s=n.defer();return null==l?o.get().then(function(n){r=n.ezb_db,e.get(r+i,c).then(function(e){localStorage.setItem(i,angular.toJson(e.data)),s.resolve(e.data)},function(e){s.reject(e.statusText+": "+e.data)})},function(e){s.reject(e.statusText+": "+e.data)}):s.resolve(JSON.parse(l)),s.promise},getOne:function(i,c){t.isLoggedIn()||a.path("/page/signin");var l={headers:{Authorization:"Bearer "+localStorage.getItem("bearer")}},s=n.defer();return o.get().then(function(n){r=n.ezb_db,e.get(r+i+"/"+c,l).then(function(e){var n=JSON.parse(localStorage.getItem(i));n[n.findIndex(n=>n.id==e.data.id)]=e.data,localStorage.setItem(i,angular.toJson(n)),s.resolve(e.data)},function(e){s.reject(e.statusText+": "+e.data)})},function(e){s.reject(e.statusText+": "+e.data)}),s.promise},set:function(i,c,l,s){t.isLoggedIn()||a.path("/page/signin");var u=localStorage.getItem("bearer"),d={headers:{"Content-Type":"application/json",Authorization:"Bearer "+u}},f=n.defer();return o.get().then(function(n){r=n.ezb_db,e({method:"PUT",url:r+i+l,headers:{"Content-Type":"application/json",Authorization:"Bearer "+u},data:c}).then(function(n){if(s){var t=JSON.parse(localStorage.getItem(i));t[t.findIndex(e=>e.id==n.data.id)]=n.data,localStorage.setItem(i,angular.toJson(t)),f.resolve(n.data)}else e.get(r+i,d).then(function(e){localStorage.setItem(i,angular.toJson(e.data)),f.resolve(e.data)},function(e){f.reject(e.statusText+": "+e.data)})},function(e){f.reject(e.statusText+": "+e.data)})}),f.promise},add:function(i,c,l){t.isLoggedIn()||a.path("/page/signin");var s=localStorage.getItem("bearer"),u={headers:{Authorization:"Bearer "+s}},d=n.defer();return o.get().then(function(n){r=n.ezb_db,e({method:"POST",url:r+i,headers:{"Content-Type":"application/json",Authorization:"Bearer "+s},data:c}).then(function(n){if(l){var t=JSON.parse(localStorage.getItem(i));t[t.findIndex(e=>e.id==n.data.id)]=n.data,localStorage.setItem(i,angular.toJson(t)),d.resolve(n.data)}else e.get(r+i,u).then(function(e){localStorage.setItem(i,angular.toJson(e.data)),d.resolve(e.data)},function(e){d.reject(e.statusText+": "+e.data)})},function(e){d.reject(e.statusText+": "+e.data)})}),d.promise},remove:function(i,c){t.isLoggedIn()||a.path("/page/signin");var l={headers:{Authorization:"Bearer "+localStorage.getItem("bearer")}},s=n.defer();return o.get().then(function(n){r=n.ezb_db,e.delete(r+i+"/"+c.id,l).then(function(){e.get(r+i,l).then(function(e){localStorage.setItem(i,angular.toJson(e.data)),s.resolve(e.data)},function(e){s.reject(e.statusText+": "+e.data)})},function(e){s.reject(e.statusText+": "+e.data)})}),s.promise},unlink:function(i,c,l,s){t.isLoggedIn()||a.path("/page/signin");var u={headers:{Authorization:"Bearer "+localStorage.getItem("bearer")}},d=n.defer();return o.get().then(function(n){r=n.ezb_db,e.delete(r+i+"/"+c.id+"/"+l,u).then(function(){s?e.get(r+i+"/"+c.id,u).then(function(e){var n=JSON.parse(localStorage.getItem(i));n[n.findIndex(n=>n.id==e.data.id)]=e.data,localStorage.setItem(i,angular.toJson(n)),d.resolve(e.data)},function(e){d.reject(e.statusText+": "+e.data)}):e.get(r+i,u).then(function(e){localStorage.setItem(i,angular.toJson(e.data)),d.resolve(e.data)},function(e){d.reject(e.statusText+": "+e.data)})},function(e){d.reject(e.statusText+": "+e.data)})}),d.promise},clearLocalStorage:function(e){var t=n.defer();return localStorage.removeItem(e),t.resolve(!0),t.promise}}}]).factory("ezApiStorage",["dbStorage","$q",function(e,n){var t=["view-svsapi","usr-svc","api-account","group-account","api-group","view-group","bastion","worker"];return{get:function(n){return e.get(n)},getOne:function(n,t){return e.getOne(n,t)},put:function(n,a,o){return o=void 0!==o?o:"",t.forEach(n=>{e.clearLocalStorage(n)}),e.set(n,a,o,!1)},putOne:function(n,a,o){return o=void 0!==o?o:"",t.forEach(n=>{e.clearLocalStorage(n)}),e.set(n,a,o,!0)},add:function(n,a){return t.forEach(n=>{e.clearLocalStorage(n)}),e.add(n,a,!1)},addOne:function(n,a){return t.forEach(n=>{e.clearLocalStorage(n)}),e.add(n,a,!0)},remove:function(n,a){return t.forEach(n=>{e.clearLocalStorage(n)}),e.remove(n,a)},unlink:function(n,a,o){return t.forEach(n=>{e.clearLocalStorage(n)}),e.unlink(n,a,o,!1)},unlinkOne:function(n,a,o){return t.forEach(n=>{e.clearLocalStorage(n)}),e.unlink(n,a,o,!0)},refresh:function(t){var a=n.defer();return e.clearLocalStorage(t).then(function(n){a.resolve(e.get(t))}),a.promise}}}])}(),function(){"use strict";angular.module("app.filter",[])}(),function(){"use strict";function e(e,n,t,a,o,r,i){t.get(i).then(function(n){e.items=n},function(e){n.logError(e)}),e.sectionName=r,e.animationsEnabled=!0,e.toggleAnimation=function(){e.animationsEnabled=!e.animationsEnabled},e.refresh=function(){t.refresh(i).then(function(t){e.items=t,n.logSuccess(r+" reloaded succesfully.")})},e.add=function(){a.open({animation:e.animationsEnabled,templateUrl:"AddModal.html",controller:"FilterModalAddCtrl",resolve:{sectionName:function(){return e.sectionName}}}).result.then(function(n){t.add(i,n).then(function(n){e.items=n})},function(){o.info("Modal dismissed at: "+new Date)})},e.status=function(a){t.put(i,a).then(function(t){e.items=t,a.enable?n.logSuccess(r+" "+a.name+" is enable."):n.logWarning(r+" "+a.name+" is disable.")})},e.edit=function(r){a.open({animation:e.animationsEnabled,templateUrl:"EditModal.html",controller:"FilterModalEditCtrl",resolve:{item:function(){return r},sectionName:function(){return e.sectionName}}}).result.then(function(a){t.put(i,a).then(function(t){e.items=t,n.logSuccess("Saved.")})},function(){o.info("Modal dismissed at: "+new Date)})},e.delete=function(c){a.open({animation:e.animationsEnabled,templateUrl:"DeleteModal.html",controller:"FilterModalDeleteCtrl",size:"sm",resolve:{item:function(){return c},sectionName:function(){return e.sectionName}}}).result.then(function(a){t.remove(i,a).then(function(t){e.items=t,n.logWarning(r+" "+a.name+" is deleted.")})},function(){o.info("Modal dismissed at: "+new Date)})},e.help=function(n,t){a.open({animation:e.animationsEnabled,templateUrl:"help.html",size:"sm"})}}angular.module("app.filter").controller("EnvironmentCtrl",["$scope","logger","ezApiStorage","$uibModal","$log",function(n,t,a,o,r){e(n,t,a,o,r,"Environment","env")}]).controller("SiteCtrl",["$scope","logger","ezApiStorage","$uibModal","$log",function(n,t,a,o,r){e(n,t,a,o,r,"Site","site")}]).controller("TypeCtrl",["$scope","logger","ezApiStorage","$uibModal","$log",function(n,t,a,o,r){e(n,t,a,o,r,"Type","type")}]).controller("AccessCtrl",["$scope","logger","ezApiStorage","$uibModal","$log",function(n,t,a,o,r){e(n,t,a,o,r,"Access","access")}]).controller("FilterModalAddCtrl",["$scope","$uibModalInstance","sectionName",function(e,n,t){e.item={name:"",comment:""},e.sectionName=t,e.ok=function(){n.close(e.item)},e.cancel=function(){n.dismiss("cancel")}}]).controller("FilterModalDeleteCtrl",["$scope","$uibModalInstance","item","sectionName",function(e,n,t,a){e.name=t,e.sectionName=a,e.ok=function(){n.close(e.name)},e.cancel=function(){n.dismiss("cancel")}}]).controller("FilterModalEditCtrl",["$scope","$uibModalInstance","item","sectionName",function(e,n,t,a){e.editItem=angular.copy(t),e.ok=function(){n.close(e.editItem)},e.cancel=function(){n.dismiss("cancel")}}])}(),function(){"use strict";angular.module("app.account",["validation.match"])}(),function(){"use strict";function e(e,n,t,a,o,r,i,c){var l,s="accounts";e.sta=[],n.get(s).then(function(n){e.items=n.filter(e=>e.type==i),l()},function(e){o.logError(e)}),n.get("stas").then(function(n){n.forEach(n=>{e.sta.push({k:n.id,v:n.name})})},function(e){o.logError(e)}),e.sectionName=c,e.searchKeywords="",e.filteredItems=[],e.row="",e.select=function(n){var t,a;return a=(n-1)*e.numPerPage,t=a+e.numPerPage,e.currentPageItems=e.filteredItems.slice(a,t)},e.onFilterChange=function(){return e.select(1),e.currentPage=1,e.row=""},e.refresh=function(){n.refresh(s).then(function(n){e.items=n.filter(e=>e.type==i),l(),o.logSuccess(c+" reloaded succesfully.")})},e.onNumPerPageChange=function(){return e.select(1),e.currentPage=1},e.search=function(){return e.filteredItems=r("filter")(e.items,e.searchKeywords),e.onFilterChange()},e.numPerPageOpt=[10,20,50,100],e.numPerPage=e.numPerPageOpt[0],e.currentPage=1,e.currentPageItems=[],l=function(){return e.search(),e.select(e.currentPage)},e.status=function(e){n.putOne(s,e,"/enable").then(function(n){(e=n).enable?o.logSuccess(c+" "+e.name+" is enable."):o.logWarning(c+" "+e.name+" is disable.")})},e.add=function(){var o="AddModal.html";"o"==i&&(o="AddOuModal.html");t.open({animation:e.animationsEnabled,templateUrl:o,controller:"AccountModalAddCtrl",resolve:{type:function(){return i},sectionName:function(){return c}}}).result.then(function(t){n.add(s,t).then(function(n){e.items=n.filter(e=>e.type==i),l()})},function(){a.info("Modal dismissed at: "+new Date)})},e.delete=function(r){t.open({animation:e.animationsEnabled,templateUrl:"DeleteModal.html",controller:"AccountModalDeleteCtrl",size:"sm",resolve:{item:function(){return r},sectionName:function(){return e.sectionName}}}).result.then(function(t){n.remove(s,t).then(function(n){e.items=n.filter(e=>e.type==i),l(),o.logWarning(c+" "+t.name+" deleted.")},function(e){o.logError(e)})},function(){a.info("Modal dismissed at: "+new Date)})},e.edit=function(r){var u;switch(i){case"i":u="EditModal.html";break;case"u":case"g":u="EditADModal.html";break;case"o":u="EditOuModal.html";break;default:u="EditModal.html"}t.open({animation:e.animationsEnabled,templateUrl:u,controller:"AccountModalEditCtrl",resolve:{item:function(){return r},sectionName:function(){return c},main:function(){return e.main},sta:function(){return e.sta}}}).result.then(function(t){if(delete t.sta,""!=t.newPWD){var a=new TextEncoder("utf-8").encode(t.newPWD+t.salt);delete t.newPWD,crypto.subtle.digest("SHA-256",a).then(function(a){for(var r=[],c=new DataView(a),u=0;u<c.byteLength;u+=4){var d=("00000000"+c.getUint32(u).toString(16)).slice(-"00000000".length);r.push(d)}t.password=r.join(""),n.put(s,t).then(function(n){e.items=n.filter(e=>e.type==i),l(),o.logSuccess("Saved.")})})}else delete t.newPWD,n.put(s,t).then(function(n){e.items=n.filter(e=>e.type==i),l(),o.logSuccess("Saved.")})},function(){a.info("Modal dismissed at: "+new Date)})},e.help=function(n,a){t.open({animation:e.animationsEnabled,templateUrl:"help.html",size:"sm"})},e.info=function(n){console.dir(n);t.open({animation:e.animationsEnabled,templateUrl:"UserInfoModal.html",controller:"AccountModalInfoCtrl",size:"lg",resolve:{item:function(){return n},sectionName:function(){return e.sectionName},type:function(){return i}}})}}angular.module("app.account").controller("adCtrl",["$scope","ezApiStorage","$uibModal","$log","logger","$filter",function(e,n,t,a,o,r){}]).controller("UserCtrl",["$scope","ezApiStorage","$uibModal","$log","logger","$filter",function(n,t,a,o,r,i){e(n,t,a,o,r,i,"u","User")}]).controller("GroupCtrl",["$scope","ezApiStorage","$uibModal","$log","logger","$filter",function(n,t,a,o,r,i){e(n,t,a,o,r,i,"g","Group")}]).controller("OuCtrl",["$scope","ezApiStorage","$uibModal","$log","logger","$filter",function(n,t,a,o,r,i){e(n,t,a,o,r,i,"o","Ou")}]).controller("ServiceCtrl",["$scope","ezApiStorage","$uibModal","$log","logger","$filter",function(n,t,a,o,r,i){e(n,t,a,o,r,i,"i","ezb account")}]).controller("AccountModalDeleteCtrl",["$scope","$uibModalInstance","item","sectionName",function(e,n,t,a){e.name=t,e.sectionName=a,e.ok=function(){n.close(e.name)},e.cancel=function(){n.dismiss("cancel")}}]).controller("AccountModalAddCtrl",["$scope","ezApiStorage","$uibModalInstance","type","sectionName",function(e,n,t,a,o){e.item={name:"",enable:!1,isadmin:!1,comment:"",type:a,real:"",email:"",password:"",salt:"",actions:[],controllers:[],collections:[]},e.sectionName=o,e.ok=function(){t.close(e.item)},e.cancel=function(){t.dismiss("cancel")}}]).controller("AccountModalInfoCtrl",["$scope","ezApiStorage","$uibModalInstance","logger","$filter","item","sectionName","type","$q",function(e,n,t,a,o,r,i,c,l){e.item=r,e.searchApi={},e.searchCollection={},angular.isArray(r.actions)||(r.actions=[]),angular.isArray(r.collections)||(r.collections=[]),e.dataReady=!1,e.sectionName=i;var s=function(t){var o=l.defer();return n.refresh(t).then(function(n){e[t]=n,o.resolve(!0)},function(e){a.logError(t+": "+e),o.reject(!1)}),o.promise};l.all([s("bastions"),s("controllers"),s("access"),s("tags"),s("jobs"),s("collections"),s("accounts"),s("accountactions"),s("api"),function(){var t=l.defer();return n.refresh("actions").then(function(o){e.actions=o,r.actions.forEach(o=>{n.getOne("actions",o.id).then(function(n){e.actions[e.actions.map(function(e){return e.id}).indexOf(o.id)]=n,r.actions[r.actions.map(function(e){return e.id}).indexOf(o.id)]=n},function(e){a.logError(e),t.reject(!1)})}),t.resolve(!0)},function(e){a.logError(storeName+": "+e),t.reject(!1)}),t.promise}()]).then(function(){e.apiList=angular.copy(e.api),console.dir("apiList:"),console.dir(e.api),r.actions.forEach(n=>{e.apiList=e.apiList.filter(e=>e.id!=n.id)}),e.collectionList=angular.copy(e.collections),r.collections.forEach(n=>{e.collectionList=e.collectionList.filter(e=>e.id!=n.id)}),e.dataReady=!0,e.viewapi=e.accountactions.filter(e=>e.accountid==r.id)}),e.addApi=function(t,a,o){e.apiList=e.apiList.filter(e=>e.id!=t.id),r.actions.push(e.actions.filter(e=>e.id==t.id)[0]),n.putOne("accounts",e.item).then(function(){s("accountactions").then(function(){e.viewapi=e.accountactions.filter(e=>e.accountid==r.id)})})},e.removeApi=function(t){n.unlink("accounts",r,"actions/"+t.id).then(function(n){r.actions=r.actions.filter(e=>e.id!=t.id),e.apiList.push(e.api.filter(e=>e.id==t.id)[0]),s("accountactions").then(function(){e.viewapi=e.accountactions.filter(e=>e.accountid==r.id)})},function(e){a.logError(e)})},e.addCollection=function(t,a,o){e.collectionList=e.collectionList.filter(e=>e.id!=t.id),r.collections.push(e.collections.filter(e=>e.id==t.id)[0]),n.putOne("accounts",e.item).then(function(){s("accountactions").then(function(){e.viewapi=e.accountactions.filter(e=>e.accountid==r.id)})})},e.removeCollection=function(t){n.unlink("accounts",r,"collections/"+t.id).then(function(n){r.collections=r.collections.filter(e=>e.id!=t.id),e.collectionList.push(e.collections.filter(e=>e.id==t.id)[0]),s("accountactions").then(function(){e.viewapi=e.accountactions.filter(e=>e.accountid==r.id)})},function(e){a.logError(e)})},e.ok=function(){t.close()}}]).controller("AccountModalEditCtrl",["$scope","$uibModalInstance","main","item","sectionName","sta",function(e,n,t,a,o,r){e.main=t,e.sta=r,e.editItem=angular.copy(a),e.editItem.newPWD="",e.sectionName=o,e.editItem.type,e.ok=function(){n.close(e.editItem)},e.cancel=function(){n.dismiss("cancel")}}])}(),function(){"use strict";angular.module("app.api",["validation.match","angularBootstrapNavTree"])}(),function(){"use strict";angular.module("app.api").controller("ApiCtrl",["$scope","ezApiStorage","$uibModal","$log","logger","$q",function(e,n,t,a,o,r){e.addToolTypeMessage="";var i;e.my_tree=i={},e.canDelete=!1,e.canDisable=!1;var c=function(t){var a=r.defer();return n.refresh(t).then(function(n){e[t]=n,a.resolve(!0)},function(e){o.logError(t+": "+e),a.reject(!1)}),a.promise};e.loadTags=function(n){return e.tags.filter(function(e){return-1!=e.name.toLowerCase().indexOf(n.toLowerCase())})},e.addTag=function(t){-1==e.tags.map(e=>e.name).indexOf(t.name)?n.putOne("tags",t).then(function(a){-1!=e.branch.data.tags.indexOf(t)&&e.branch.data.tags.pop(),e.branch.data.tags.push(a),n.putOne("actions",e.branch.data,"/tag/"+a.id).then(function(n){e.branch.data=n},function(e){o.logError(e)})},function(e){o.logError(e)}):n.putOne("actions",e.branch.data,"/tag/"+t.id).then(function(n){e.branch.data=n},function(e){o.logError(e)})},e.removeTag=function(t){n.unlinkOne("actions",e.branch.data,"tag/"+t.id).then(function(n){e.branch.data=n,angular.isArray(e.branch.data.tags)||(e.branch.data.tags=[]),e.actions[e.actions.findIndex(e=>e.id==n.id)]=n},function(e){o.logError("Update action"+e)})},e.my_tree_handler=function(e){return l(e)},e.refreshTreeData=function(){n.refresh("controllers").then(function(n){e.controllers=n}),n.refresh("actions").then(function(n){e.actions=n}),f(),i.expand_branch(i.select_branch(i.get_first_branch()))};var l=function(t){switch(console.dir(t),e.branch=t,t.data&&(t.data.enable?-1!=t.classes.indexOf("text-danger")&&(t.classes=t.classes.filter(e=>"text-danger"!=e)):-1==t.classes.indexOf("text-danger")&&t.classes.push("text-danger")),t.level){case 1:var a=1;e.controllers.length&&(a=Math.max(...e.controllers.map(e=>e.version))),e.newController={name:null,enable:!1,comment:null,version:a},e.addToolTypeMessage="",e.scopetree="Root",e.canDelete=!1,e.canDisable=!1,d(),e.CTRLIsCollapsed=!1;break;case 2:t.children.length?e.canDelete=!1:e.canDelete=!0,e.newAction={name:null,enable:!1},e.addToolTypeMessage="Add action",e.editController=angular.copy(t.data),e.scopetree="add action | edit ctrl",e.canDisable=!0,d(),e.ActionListIsCollapsed=!1;break;case 3:e.addToolTypeMessage="Add methode",e.newNameAction=t.label,t.classes=t.classes.filter(e=>"text-danger"!=e);var c=i.get_selected_branch(),l=i.get_parent_branch(c);e.newMethode={name:c.label,enable:!1,comment:null,controllers:l.data,ezbcontrollersid:l.data.id,ezbaccessid:1},e.scopetree="edit action | add api verb + path & query & body",e.canDelete=!1,e.canDisable=!1,d(),e.MethodeIsCollapsed=!1;break;case 4:!function(t){var a=r.defer();n.getOne("actions",t.id).then(function(n){e.branch.data=n,angular.isArray(e.branch.data.tags)||(e.branch.data.tags=[]),e.actions[e.actions.findIndex(e=>e.id==n.id)]=n,a.resolve(!0)},function(e){o.logError(e),a.reject(!1)}),a.promise}(t.data),e.addToolTypeMessage="Add job",e.scopetree="edit api |choose job",0==t.data.ezbjobsid&&(t.data.jobs=null),e.canDelete=!0,e.canDisable=!0,d(),e.ActionIsCollapsed=!1;break;default:e.addToolTypeMessage="",e.scopetree="param job",e.canDelete=!0,e.canDisable=!0,e.pb=i.get_parent_branch(t);var s=[];angular.isArray(e.pb.data.tags)&&e.pb.data.tags.forEach(e=>{s.push(e.name)});var u=[e.pb.data.controllers.name,e.pb.data.name];e.pb.data.path.split("/").forEach(e=>{u.push(e.replace(/\|s/,"").replace(/\|i/,""))});var f=[];e.pb.data.query.split("&").forEach(e=>{var n=e.split("="),t={};t[n[0]]=n[1],f.push(t)}),e.tagList=angular.toJson(s),e.pathList=angular.toJson(u),e.queryList=angular.toJson(f),d(),e.JobIsCollapsed=!1}},s=function(e,t){var a=i.get_parent_branch(t);n.remove(e,t.data).then(function(e){var n=a.children.filter(e=>e.uid!=t.uid);if(4==t.level&&0==n.length){var o=i.get_parent_branch(a);i.select_branch(o),o.children=o.children.filter(e=>e.uid!=a.uid)}else i.select_branch(a),a.children=n},function(e){o.logError(e)})},u=function(t,a){n.putOne(t,a,"/enable").then(function(n){n.enable?(e.branch.classes=e.branch.classes.filter(e=>"text-danger"!=e),o.logSuccess(t+" "+n.name+" is enable.")):(e.branch.classes.push("text-danger"),o.logWarning(t+" "+n.name+" is disable.")),e[t][e[t].findIndex(e=>e.id==n.id)]=n})};e.submitAddNewController=function(){var t=angular.copy(e.newController);n.add("controllers",t).then(function(n){e.controllers=n,e.newController={};var a=n.filter(e=>e.name==t.name)[0],o={label:"v"+a.version+"/"+a.name,data:a,children:[],classes:[]},r=i.get_first_branch(),c=i.add_branch(r,o);c.classes=[],c.level=2,i.expand_branch(i.select_branch(c))},function(e){o.logError(e)})},e.submitAddNewAction=function(){var t=angular.copy(e.newAction),a=i.get_selected_branch();t.ezbcontrollersid=a.data.id,n.getOne("access","GET").then(function(r){t.ezbaccessid=r.id,n.add("actions",t).then(function(n){e.actions=n,e.newAction={};var o={label:r.name,data:n.filter(e=>e.name==t.name)[0],children:[],level:4,classes:[]},c={label:t.name,data:n.filter(e=>e.name==t.name)[0],children:[],classes:[],level:3},l=(i.add_branch(a,c),i.add_branch(c,o));i.expand_branch(i.select_branch(l))},function(e){o.logError(e)})},function(e){o.logError(e)})},e.submitAddActionMethode=function(){var t=angular.copy(e.newMethode),a=e.access.filter(e=>e.id==t.ezbaccessid)[0];t.access=a;var r=i.get_selected_branch();n.addOne("actions",t).then(function(n){e.actions.push(n),e.newMethode={},t=null;var o={label:a.name,data:n,children:[],classes:[],level:4};i.expand_branch(i.select_branch(i.add_branch(r,o))),a=null},function(e){o.logError(e)})},e.submitAddJob=function(){var t=e.branch.data.jobs;t.id?(e.branch.data.ezbjobsid=t.id,n.put("actions",e.branch.data).then(function(n){e.actions=n;var a=n.filter(n=>n.id==e.branch.data.id)[0],o=i.get_selected_branch();o.data=a;var r={label:t.name,data:t,children:[],classes:[],level:5};i.select_branch(i.add_branch(o,r))})):n.addOne("jobs",t).then(function(t){e.branch.data.ezbjobsid=t.id,e.branch.data.jobs=t,e.jobs.push(t),n.put("actions",e.branch.data).then(function(n){e.actions=n;var a=n.filter(n=>n.id==e.branch.data.id)[0],o=i.get_selected_branch();o.data=a;var r={label:t.name,data:t,children:[],classes:[],level:5};i.select_branch(i.add_branch(o,r))})},function(e){o.logError(e)})},e.submitEditController=function(){var t=i.get_selected_branch(),a=t.data;a.name=e.editController.name,a.comment=e.editController.comment,a.version=e.editController.version,n.put("controllers",a).then(function(n){e.controllers=n;var o=i.get_selected_branch(),r=n.filter(e=>e.id==a.id)[0];o.label="v"+r.version+"/"+r.name,e.branch.data.name=r.name,e.branch.data.comment=r.comment,e.branch.data.version=r.version,i.get_children(t).forEach(e=>{e.children.forEach(e=>{e.data.controllers=r})})},function(e){o.logError(e)})},e.submitEditActionName=function(){var t=e.newNameAction;e.branch.children.forEach(a=>{a.data.name=t,n.put("actions",a.data,"/rename").then(function(n){e.actions=n}),e.branch.label=t})},e.submitEditActionMethode=function(){var t=i.get_selected_branch(),a=e.branch.data.ezbaccessid;t.data.ezbaccessid=t.data.access.id,0==t.data.ezbjobsid&&(delete t.data.jobs,delete t.data.ezbjobsid),n.put("actions",t.data).then(function(n){t.label=t.data.access.name+" "+t.data.path,e.actions=n},function(e){t.data.ezbaccessid=a,o.logError(e)})},e.submitEditActionPathQuery=function(){n.put("actions",e.branch.data).then(function(n){e.branch.label=e.branch.data.access.name+" "+e.branch.data.path,e.actions=n},function(e){o.logError(e)})},e.submitEditJob=function(){n.put("jobs",e.branch.data).then(function(n){e.branch.label=e.branch.data.name,e.jobs=n},function(e){o.logError(e)})},e.statusBranch=function(e){switch(e.level){case 1:break;case 2:u("controllers",e.data);break;case 3:break;case 4:u("actions",e.data);break;case 5:u("jobs",e.data)}},e.anonymousBranch=function(t){n.putOne("actions",t.data).then(function(n){e.actions[e.actions.findIndex(e=>e.id==n.id)]=n})},e.deleteBranch=function(t){switch(t.level){case 1:break;case 2:window.alert("Warning you will remove XXX api to XXX users !"),s("controllers",t);break;case 3:break;case 4:s("actions",t);break;case 5:var a=i.get_parent_branch(t);a.children=[],a.data.ezbjobsid=0,n.unlink("actions",a.data,"job").then(function(n){e.actions=n},function(e){o.logError(e)}),i.select_branch(a)}},e.deprecated=function(){0==e.branch.data.ezbjobsid&&(delete e.branch.data.jobs,delete e.branch.data.ezbjobsid),n.put("actions",e.branch.data).then(function(n){e.actions=n},function(e){o.logError(e)})};var d=function(){e.CTRLIsCollapsed=!0,e.ActionIsCollapsed=!0,e.ActionListIsCollapsed=!0,e.MethodeIsCollapsed=!0,e.JobIsCollapsed=!0},f=function(){d(),r.all([c("bastions"),c("controllers"),c("access"),c("actions"),c("tags"),c("jobs")]).then(function(){!function(){var n=[{label:"ezb.group",data:"",children:[]}];n[0].level=1,n[0].classes=[],n[0].label=e.bastions[0].name,e.controllers.forEach(t=>{var a={};a.label="v"+t.version+"/"+t.name,a.data=t,a.level=2,t.enable||(a.classes=["text-danger"]),a.children=[];var o=[];e.actions.filter(e=>e.controllers.id==t.id).filter(function(e){return o.findIndex(n=>n.name==e.name)<=-1&&o.push({id:e.id,name:e.name}),null}),o.forEach(n=>{var o={};o.label=n.name,o.children=[],o.level=3,e.actions.filter(e=>e.controllers.id==t.id).filter(e=>e.name==n.name).forEach(n=>{var t={};if(n.enable||(t.classes=["text-danger"]),t.data=n,t.label=n.access.name+"  "+n.path,t.children=[],t.level=4,n.jobs.id>0){var a=e.jobs[e.jobs.map(function(e){return e.id}).indexOf(n.jobs.id)],r={};r.label=a.name,r.data=a,r.level=5,a.enable||(r.classes=["text-danger"]),t.children.push(r)}o.children.push(t)}),a.children.push(o)}),n[0].children.push(a)}),e.my_data=n}()})};f(),e.animationsEnabled=!0,e.toggleAnimation=function(){e.animationsEnabled=!e.animationsEnabled},e.helpApi=function(){t.open({animation:e.animationsEnabled,templateUrl:"helpApi.html",size:"sm"})},e.helpAction=function(){t.open({animation:e.animationsEnabled,templateUrl:"helpAction.html",size:"sm"})}}]).controller("ApiModalDeleteCtrl",["$scope","$uibModalInstance","item","sectionName",function(e,n,t,a){e.name=t.name,e.sectionName=a,e.ok=function(){n.close(t)},e.cancel=function(){n.dismiss("cancel")}}]).controller("ApiGroupModalDeleteCtrl",["$scope","ezApiStorage","$uibModalInstance","$q","item",function(e,n,t,a,o){var r=function(t){var o=a.defer();return n.get(t).then(function(n){e[t]=n,o.resolve(!0)},function(e){logger.logError(t+": "+e),o.reject(!1)}),o.promise};a.all([r("bastions"),r("controllers"),r("access"),r("jobs")]).then(function(){e.item=angular.copy(o),null!=e.item.actions&&e.item.actions.forEach(n=>{null!=n.controllers&&(n.controllers=e.controllers.filter(e=>e.id==n.ezbcontrollersid)[0]),null!=n.access&&(n.access=e.access.filter(e=>e.id==n.ezbaccessid)[0]),null!=n.jobs&&(n.jobs=e.jobs.filter(e=>e.id==n.ezbjobsid)[0])})});var i={item:o};e.ok=function(){t.close(i)},e.cancel=function(){t.dismiss("cancel")}}]).controller("GroupModalAddCtrl",["$scope","$uibModalInstance","sectionName",function(e,n,t){e.item={name:"",comment:"",enable:!1},e.sectionName=t,e.ok=function(){n.close(e.item)},e.cancel=function(){n.dismiss("cancel")}}]).controller("scriptModalAddCtrl",["$scope","$uibModalInstance","sectionName",function(e,n,t){e.item={name:"",comment:"",enable:!1,filename:"",checksum:""},e.sectionName=t,e.ok=function(){n.close(e.item)},e.cancel=function(){n.dismiss("cancel")}}]).controller("ApiModalEditCtrl",["$scope","$uibModalInstance","item","sectionName",function(e,n,t,a){e.editItem=angular.copy(t),e.ok=function(){n.close(e.editItem)},e.cancel=function(){n.dismiss("cancel")}}]).controller("ApiModalScriptEditCtrl",["$scope","$uibModalInstance","item","sectionName",function(e,n,t,a){e.item=angular.copy(t),e.ok=function(){n.close(e.item)},e.cancel=function(){n.dismiss("cancel")}}]).controller("ApiGroupModalInfoCtrl",["$scope","$q","ezApiStorage","$uibModalInstance","logger","$filter","item","sectionName",function(e,n,t,a,o,r,i,c){e.item=i,e.searchApi={},angular.isArray(i.actions)||(i.actions=[]),e.dataReady=!1,e.sectionName=c;var l=function(a){var r=n.defer();return t.refresh(a).then(function(n){e[a]=n,r.resolve(!0)},function(e){o.logError(a+": "+e),r.reject(!1)}),r.promise},s=function(){n.all([l("bastions"),l("controllers"),l("access"),l("tags"),l("jobs"),l("collections"),l("accounts"),l("accountactions"),l("api"),function(){var a=n.defer();return t.refresh("actions").then(function(n){e.actions=n,i.actions.forEach(n=>{t.getOne("actions",n.id).then(function(t){e.actions[e.actions.map(function(e){return e.id}).indexOf(n.id)]=t,i.actions[i.actions.map(function(e){return e.id}).indexOf(n.id)]=t},function(e){o.logError(e),a.reject(!1)})}),a.resolve(!0)},function(e){o.logError(e),a.reject(!1)}),a.promise}()]).then(function(){e.apiList=angular.copy(e.api),i.actions.forEach(n=>{e.apiList=e.apiList.filter(e=>e.id!=n.id)}),e.dataReady=!0})};e.addApi=function(n,a,o){e.apiList=e.apiList.filter(e=>e.id!=n.id),i.actions.push(e.actions.filter(e=>e.id==n.id)[0]),t.putOne("collections",e.item)},e.removeApi=function(n){t.unlink("collections",i,n.id).then(function(t){i.actions=i.actions.filter(e=>e.id!=n.id),e.apiList.push(e.api.filter(e=>e.id==n.id)[0])},function(e){o.logError(e)})},s(),e.showAddApiForm=function(){e.addApiIsCollapsed=!e.addApiIsCollapsed},e.submitAddApiForm=function(){e.newapi.group=i,e.newapi.idapi=e.newapi.api.id,e.newapi.idaccess=e.newapi.access.id,e.newapi.idgrp=e.newapi.group.id,e.newapi.idrunas=e.newapi.runas.id,e.newapi.idaction=e.newapi.action.id,e.newapi.idtype=e.newapi.type.id,e.newapi.idenv=e.newapi.env.id,e.newapi.idsite=e.newapi.site.id,t.add("api-group",e.newapi).then(function(e){s()},function(e){o.logError(e)})},e.resetAddApiForm=function(){e.addApiIsCollapsed=!e.addApiIsCollapsed,e.newapi={}},e.addAccount=function(e,n,a){var r={account:e,idusr:e.id,group:i,idgrp:i.id};t.add("group-account",r).then(function(e){s()},function(e){o.logError(e)})},e.removeAccount=function(e){t.remove("group-account",e).then(function(e){s()},function(e){o.logError(e)})},e.ok=function(){a.close()},e.apiGroups=[],e.groupAccounts=[],e.Accounts=[],t.get("accounts").then(function(n){e.Accounts=n},function(e){o.logError(e)}),e.addApiIsCollapsed=!0,e.newapi={},e.accountToAdd="",e.viewgroup=[]}]).controller("ApiScriptCtrl",["$scope","ezApiStorage","$uibModal","$log","logger","$filter",function(e,n,t,a,o,r){var i;n.get("jobs").then(function(n){e.items=n,i()},function(e){o.logError(e)});var c=e.sectionName="Job";e.searchKeywords="",e.filteredItems=[],e.row="",e.select=function(n){var t,a;return a=(n-1)*e.numPerPage,t=a+e.numPerPage,e.currentPageItems=e.filteredItems.slice(a,t)},e.onFilterChange=function(){return e.select(1),e.currentPage=1,e.row=""},e.refresh=function(){n.refresh("jobs").then(function(n){e.items=n,i(),o.logSuccess(c+" reloaded succesfully.")})},e.onNumPerPageChange=function(){return e.select(1),e.currentPage=1},e.search=function(){return e.filteredItems=r("filter")(e.items,e.searchKeywords),e.onFilterChange()},e.numPerPageOpt=[10,20,50,100],e.numPerPage=e.numPerPageOpt[0],e.currentPage=1,e.currentPageItems=[],i=function(){return e.search(),e.select(e.currentPage)},e.help=function(n,a){t.open({animation:e.animationsEnabled,templateUrl:"help.html",size:"sm"})},e.add=function(){t.open({animation:e.animationsEnabled,templateUrl:"AddScriptModal.html",controller:"scriptModalAddCtrl",resolve:{sectionName:function(){return e.sectionName}}}).result.then(function(t){n.add("jobs",t).then(function(n){e.items=n,e.searchKeywords=t.name,i()})},function(){a.info("Modal dismissed at: "+new Date)})},e.status=function(t){n.put("jobs",t).then(function(n){e.items=n,t.enable?o.logSuccess(c+" "+t.name+" is enable."):o.logWarning(c+" "+t.name+" is disable.")})},e.delete=function(r){t.open({animation:e.animationsEnabled,templateUrl:"DeleteModal.html",controller:"ApiModalDeleteCtrl",resolve:{item:function(){return r},sectionName:function(){return e.sectionName}}}).result.then(function(t){n.remove("jobs",t).then(function(n){e.items=n,e.searchKeywords=e.searchKeywords==t.name?"":e.searchKeywords,i(),o.logWarning(c+" "+t.name+" deleted.")},function(e){o.logError(e)})},function(){a.info("Modal dismissed at: "+new Date)})},e.edit=function(r){t.open({animation:e.animationsEnabled,templateUrl:"EditScriptModal.html",controller:"ApiModalScriptEditCtrl",resolve:{item:function(){return r},sectionName:function(){return e.sectionName}}}).result.then(function(t){n.put("jobs",t).then(function(n){e.items=n,i(),o.logSuccess("Saved.")})},function(){a.info("Modal dismissed at: "+new Date)})}}]).controller("ApiGroupCtrl",["$scope","ezApiStorage","$uibModal","$log","logger","$filter",function(e,n,t,a,o,r){var i,c="collections";n.get(c).then(function(n){e.items=n,i()},function(e){o.logError(e)}),n.get("controllers").then(function(n){e.controllers=n},function(e){o.logError(e)});var l=e.sectionName="Collections";e.searchKeywords="",e.filteredItems=[],e.row="",e.select=function(n){var t,a;return a=(n-1)*e.numPerPage,t=a+e.numPerPage,e.currentPageItems=e.filteredItems.slice(a,t)},e.onFilterChange=function(){return e.select(1),e.currentPage=1,e.row=""},e.refresh=function(){n.refresh(c).then(function(n){e.items=n,i(),o.logSuccess(l+" reloaded succesfully.")})},e.onNumPerPageChange=function(){return e.select(1),e.currentPage=1},e.search=function(){return e.filteredItems=r("filter")(e.items,e.searchKeywords),e.onFilterChange()},e.numPerPageOpt=[10,20,50,100],e.numPerPage=e.numPerPageOpt[0],e.currentPage=1,e.currentPageItems=[],i=function(){return e.search(),e.select(e.currentPage)},e.help=function(n,a){t.open({animation:e.animationsEnabled,templateUrl:"help.html",size:"sm"})},e.add=function(){t.open({animation:e.animationsEnabled,templateUrl:"AddModal.html",controller:"GroupModalAddCtrl",resolve:{sectionName:function(){return e.sectionName}}}).result.then(function(t){n.add(c,t).then(function(n){e.items=n,i()})},function(){a.info("Modal dismissed at: "+new Date)})},e.status=function(t){n.put(c,t).then(function(n){e.items=n,t.enable?o.logSuccess(l+" "+t.name+" is enable."):o.logWarning(l+" "+t.name+" is disable.")})},e.delete=function(r){t.open({animation:e.animationsEnabled,templateUrl:"GroupDeleteModal.html",controller:"ApiGroupModalDeleteCtrl",resolve:{item:function(){return r}}}).result.then(function(t){n.remove("collections",t.item).then(function(n){e.items=n,i(),o.logWarning(l+" "+t.item.name+" is deleted.")},function(e){o.logError(e)})},function(){a.info("Modal dismissed at: "+new Date)})},e.edit=function(r){t.open({animation:e.animationsEnabled,templateUrl:"EditModal.html",controller:"ApiModalEditCtrl",resolve:{item:function(){return r},sectionName:function(){return e.sectionName}}}).result.then(function(t){n.put(c,t).then(function(n){e.items=n,i(),o.logSuccess("Saved.")})},function(){a.info("Modal dismissed at: "+new Date)})},e.info=function(n){t.open({animation:e.animationsEnabled,templateUrl:"ApiGroupInfoModal.html",controller:"ApiGroupModalInfoCtrl",size:"lg",resolve:{item:function(){return n},sectionName:function(){return e.sectionName}}})}}])}(),function(){"use strict";angular.module("app.server",["validation.match","app.filter"])}(),function(){"use strict";angular.module("app.server").controller("ServerCtrl",["$scope","ezApiStorage","$uibModal","$log","logger",function(e,n,t,a,o){}]).controller("WorkerCtrl",["$scope","ezApiStorage","$uibModal","$log","logger","$filter","$q",function(e,n,t,a,o,r,i){var c;e.numPerPageOpt=[10,20,50,100],e.numPerPage=e.numPerPageOpt[0],e.currentPage=1,e.currentPageItems=[],e.searchKeywords="",e.filteredItems=[],e.row="",e.max=0;var l=e.sectionName="Workers",s="workers";e.refresh=function(){n.refresh(s).then(function(n){e.items=n,c(),o.logSuccess(l+" reloaded succesfully.")},function(e){o.logError(e)})},e.select=function(n){var t,a;return a=(n-1)*e.numPerPage,t=a+e.numPerPage,e.currentPageItems=e.filteredItems.slice(a,t)},e.onFilterChange=function(){return e.select(1),e.currentPage=1,e.row=""},e.onNumPerPageChange=function(){return e.select(1),e.currentPage=1},e.search=function(n){return e.filteredItems=r("filter")(e.items,n),e.onFilterChange()},e.help=function(n,a){t.open({animation:e.animationsEnabled,templateUrl:"help.html",size:"sm"})},e.add=function(){t.open({animation:e.animationsEnabled,templateUrl:"AddModal.html",controller:"ModalAdd",resolve:{sectionName:function(){return e.sectionName}}}).result.then(function(t){n.add(s,t).then(function(n){e.items=n,c()},function(e){o.logError(e)})},function(){a.info("Modal dismissed at: "+new Date)})},e.delete=function(r){t.open({animation:e.animationsEnabled,templateUrl:"DeleteModal.html",controller:"ModalDelete",resolve:{item:function(){return r},sectionName:function(){return l}}}).result.then(function(t){n.remove(s,t).then(function(){e.refresh(),o.logWarning(t.item.name+" deleted.")},function(e){o.logError(e)})},function(){a.info("Modal dismissed at: "+new Date)})},e.status=function(t){if(!t.fqdn)return t.enable=!1,void o.logWarning("Set FQDN befor enable worker.");n.put(s,t).then(function(n){e.items=n,t.enable?o.logSuccess(l+" "+t.name+" is enable."):o.logWarning(l+" "+t.name+" is disable.")})},e.edit=function(r){t.open({animation:e.animationsEnabled,templateUrl:"EditModalWorker.html",controller:"ModalEdit",resolve:{item:function(){return r},sectionName:function(){return e.sectionName}}}).result.then(function(t){n.put(s,t).then(function(n){e.items=n,c(),o.logSuccess("Saved.")})},function(){a.info("Modal dismissed at: "+new Date)})},e.info=function(n){if(!n.fqdn)return n.enable=!1,void o.logWarning("Set FQDN befor enable worker.");t.open({animation:e.animationsEnabled,templateUrl:"infoworkermodal.html",controller:"ModalWorkerInfo",size:"lg",resolve:{item:function(){return n},sectionName:function(){return e.sectionName}}})},c=function(){return e.search(),e.max=e.items.map(function(e){return e.request}).reduce(function(e,n){return e+n}),e.select(e.currentPage)},function(){var t=i.defer();return n.get(s).then(function(n){e.items=n,c(),t.resolve(!0)},function(e){t.reject(!1),o.logError(e)}),t.promise}().then(function(){console.dir(e.items)})}]).controller("StaCtrl",["$scope","ezApiStorage","$uibModal","$log","logger","$filter","$q",function(e,n,t,a,o,r,i){e.type=[{k:0,v:"Internal"},{k:1,v:"AD"}];var c;e.numPerPageOpt=[10,20,50,100],e.numPerPage=e.numPerPageOpt[0],e.currentPage=1,e.currentPageItems=[],e.searchKeywords="",e.filteredItems=[],e.row="";var l=e.sectionName="STA",s="stas";e.refresh=function(){n.refresh(s).then(function(n){e.items=n,c(),o.logSuccess(l+" reloaded succesfully.")},function(e){o.logError(e)})},e.select=function(n){var t,a;return a=(n-1)*e.numPerPage,t=a+e.numPerPage,e.currentPageItems=e.filteredItems.slice(a,t)},e.onFilterChange=function(){return e.select(1),e.currentPage=1,e.row=""},e.onNumPerPageChange=function(){return e.select(1),e.currentPage=1},e.search=function(n){return e.filteredItems=r("filter")(e.items,n),e.onFilterChange()},e.help=function(n,a){t.open({animation:e.animationsEnabled,templateUrl:"help.html",size:"sm"})},e.add=function(){t.open({animation:e.animationsEnabled,templateUrl:"AddModal.html",controller:"ModalAdd",resolve:{sectionName:function(){return e.sectionName}}}).result.then(function(t){n.add(s,t).then(function(n){e.items=n,c()})},function(){a.info("Modal dismissed at: "+new Date)})},e.delete=function(r){t.open({animation:e.animationsEnabled,templateUrl:"DeleteModal.html",controller:"ModalDelete",resolve:{item:function(){return r},sectionName:function(){return l}}}).result.then(function(t){n.remove(s,t).then(function(){e.refresh(),o.logWarning(t.item.name+" deleted.")},function(e){o.logError(e)})},function(){a.info("Modal dismissed at: "+new Date)})},e.status=function(t){if(!t.authorization_endpoint)return t.enable=!1,void o.logWarning("Set authorization_endpoint befor enable IAM.");n.put(s,t).then(function(n){e.items=n,t.enable?o.logSuccess(l+" "+t.name+" is enable."):o.logWarning(l+" "+t.name+" is disable.")})},e.edit=function(r){t.open({animation:e.animationsEnabled,templateUrl:"EditModalIAM.html",controller:"ModalEdit",resolve:{item:function(){return r},sectionName:function(){return e.sectionName}}}).result.then(function(t){n.put(s,t).then(function(n){e.items=n,c(),o.logSuccess("Saved.")})},function(){a.info("Modal dismissed at: "+new Date)})},e.info=function(n){if(!n.fqdn)return n.enable=!1,void o.logWarning("Set FQDN befor enable worker.");t.open({animation:e.animationsEnabled,templateUrl:"infoworkermodal.html",controller:"ModalWorkerInfo",size:"lg",resolve:{item:function(){return n},sectionName:function(){return e.sectionName}}})},c=function(){return e.search(),e.select(e.currentPage)},function(){var t=i.defer();return n.get(s).then(function(n){e.items=n,c(),t.resolve(!0)},function(e){t.reject(!1),o.logError(e)}),t.promise}().then(function(){var t=!1;e.items.forEach(a=>{if("changeME"==a.issuer){var o=JSON.parse(localStorage.getItem("ezb_conf"));a.issuer=o.iss,t=!0}if("http://change.me/token"==a.authorization_endpoint){var r=JSON.parse(localStorage.getItem("ezb_url"));a.authorization_endpoint=r.ezb_sta,t=!0}t&&n.put(s,a).then(function(n){e.items=n,c()})}),console.dir(e.items)})}]).controller("BastionCtrl",["$scope","ezApiStorage","$uibModal","$log","logger",function(e,n,t,a,o){e.refreshBastion=function(){n.refresh("bastions").then(function(n){e.bastion=n[0],o.logSuccess("Bastions reloaded succesfully.")},function(e){o.logError(e)})},e.help=function(n,a){t.open({animation:e.animationsEnabled,templateUrl:"help.html",size:"sm"})},e.editBastion=function(){n.put("bastions",e.bastion).then(function(n){e.bastion=n[0]})},n.get("bastions").then(function(n){e.bastion=n[0],console.dir(n)},function(e){o.logError(e)})}]).controller("ModalAdd",["$scope","$uibModalInstance","sectionName",function(e,n,t){e.item={name:"",comment:"",enable:!1},e.sectionName=t,e.ok=function(){n.close(e.item)},e.cancel=function(){n.dismiss("cancel")}}]).controller("ModalEdit",["$scope","$uibModalInstance","item","sectionName",function(e,n,t,a){e.type=[{k:0,v:"Internal"},{k:1,v:"AD"}],e.sectionName=a,e.editItem=angular.copy(t),e.ok=function(){n.close(e.editItem)},e.cancel=function(){n.dismiss("cancel")}}]).controller("ModalWorkerInfo",["$scope","$uibModalInstance","item","sectionName","$q","ezApiStorage","$log","logger",function(e,n,t,a,o,r,i,c){e.sectionName=a,e.item=t,angular.isArray(t.tags)||(t.tags=[]),e.loadTags=function(n){return e.tags.filter(function(e){return-1!=e.name.toLowerCase().indexOf(n.toLowerCase())})},e.addTag=function(n){-1==e.tags.map(e=>e.name).indexOf(n.name)?r.putOne("tags",n).then(function(e){-1!=t.tags.indexOf(n)&&t.tags.pop(),t.tags.push(e),r.putOne("workers",t,"/tag/"+e.id).then(function(e){t=e},function(e){c.logError(e)})},function(e){c.logError(e)}):r.putOne("workers",t,"/tag/"+n.id).then(function(e){t=e},function(e){c.logError(e)})},e.removeTag=function(e){r.unlinkOne("workers",t,"tag/"+e.id).then(function(e){t=e,angular.isArray(t.tags)||(t.tags=[])},function(e){c.logError("Update action"+e)})},function(n){var t=o.defer();r.refresh(n).then(function(a){e[n]=a,t.resolve(!0)},function(e){c.logError(n+": "+e),t.reject(!1)}),t.promise}("tags"),e.cancel=function(){n.dismiss("cancel")}}]).controller("ModalDelete",["$scope","$uibModalInstance","item","sectionName",function(e,n,t,a){e.name=t.name,e.sectionName=a,e.ok=function(){n.close(t)},e.cancel=function(){n.dismiss("cancel")}}])}(),function(){"use strict";angular.module("app.log",[])}(),function(){"use strict";angular.module("app.log").controller("LogCtrl",["$rootScope","$scope","ezApiStorage","logger","$uibModal","$log","$interval",function(e,n,t,a,o,r,i){n.nberr={selected:{id:1,val:10},available:[{id:1,val:10},{id:2,val:20},{id:3,val:50},{id:4,val:100}]},n.errors=[];var c=function(){t.refresh("logs/lasterror/"+n.nberr.selected.val).then(function(e){n.errors=e},function(e){a.logError(e)})};c(),n.$watch("nberr.selected.id",function(e,n,t){angular.equals(e,n)||e&&c()})}])}(),function(){"use strict";angular.module("app.engine",[])}(),function(){"use strict";angular.module("app.engine").controller("LicenseCtrl",["$scope","logger","ezApiStorage","$uibModal","$log","$q",function(e,n,t,a,o,r){var i;e.licensekey={},e.alerts=[];var c=function(a){var o=r.defer();return t.refresh(a).then(function(n){e[a]=n,o.resolve(!0)},function(e){n.logError(a+": "+e),o.reject(!1)}),o.promise};i=function(){r.all([c("license"),c("workers"),c("actions")]).then(function(){switch(e.maxWorkers=e.license.workers,e.maxApi=e.license.api,e.usedWorkers=e.workers.length,e.usedApi=e.actions.length,e.classWorkers=l(e.usedWorkers,e.maxWorkers),e.classApi=l(e.usedApi,e.maxApi),e.licensekey.uuid=e.license.uuid,e.license.level){case"LTE":e.level="Community",e.saexpiry=0;break;case"ENT":e.level="Enterprise",e.saexpiry=new Date(e.license.saexpiry);break;default:e.level="Unknown"}})};var l=function(e,n){var t={};return t.class="success",t.percent=Math.floor(100*e/n),t.percent>75?t.class="danger":t.percent>50&&(t.class="warning"),t};e.submitLicense=function(){var n={};n.lic=e.licensekey.key.split(".")[0],n.sig=e.licensekey.key.split(".")[1],t.put("license",n).then(function(n){i(),e.alerts.push({type:"info",msg:"License imported. Please restart ezb_DB to apply."})},function(n){e.alerts.push({type:"danger",msg:"Invalide license key."})})},e.closeAlert=function(n){return e.alerts.splice(n,1)},e.refresh=function(){i()},i()}]).controller("TagsCtrl",["$scope","logger","ezApiStorage","$uibModal","$log","$q",function(e,n,t,a,o,r){var i;e.tags=[];var c=function(a){var o=r.defer();return t.refresh(a).then(function(n){e[a]=n,o.resolve(!0)},function(e){n.logError(a+": "+e),o.reject(!1)}),o.promise};i=function(){r.all([c("tags"),c("workers"),c("actions")]).then(function(){})},e.refresh=function(){e.tags=[],c("tags")},e.help=function(){},e.removeTags=function(){(function(){var a=r.defer();return e.tags.filter(e=>1==e.selected).forEach(e=>{t.remove("tags",e).then(function(){console.dir("deleted: "+e.name),a.resolve(!0)},function(e){n.logError(e)})}),a.promise})().then(function(){c("tags"),c("workers")})},i()}])}();